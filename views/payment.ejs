<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet">

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet">

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet">
    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/public.css">
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet">

    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Belleza&display=swap"
      rel="stylesheet">

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      rel="stylesheet">

    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/darkMode.css">
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        :root {
            --primary: #4A90E2;
            --primary-foreground: #FFFFFF;
            --secondary: #50E3C2;
            --secondary-foreground: #000000;
            --accent: #FF7F50;
            --accent-foreground: #FFFFFF;
            --background: #F8F9FA;
            --foreground: #212529;
            --card: #FFFFFF;
            --card-foreground: #212529;
            --border: #DEE2E6;
            --input: #E9ECEF;
            --ring: #4A90E2;
            --radius: 0.5rem;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --gold: goldenrod;
        }

        body {
            color: var(--foreground);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background);
        }

        /* Navbar Styles */
        .navv-bar {
            font-family: 'Belleza', sans-serif;
        }

        .logo {
            font-family: 'Dancing Script', cursive;
            font-weight: 700;
            color: var(--gold);
        }

        .nav-links ul {
            display: flex;
            gap: 1.5rem;
        }

        .nav-link {
            color: var(--foreground);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

            .nav-link:hover {
                color: var(--gold);
            }

        .menu-btn {
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Card & Form Styles */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: none;
        }

        .form-control {
            border-color: var(--border);
            border-radius: var(--radius);
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }

            .form-control:focus {
                border-color: var(--ring);
                box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
            }

        .btn-gold {
            background-color: var(--gold);
            border-color: var(--gold);
            color: white;
            transition: all 0.3s ease;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

            .btn-gold:hover {
                background-color: #c7931a;
                border-color: #c7931a;
                color: white;
            }

        .page-title {
            font-size: 2.2rem;
            text-align: center;
            margin-bottom: 1rem;
            color: goldenrod;
            font-weight: 600;
            font-family: 'Dancing Script', cursive;
        }

        .page-subtitle {
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 2.5rem;
            color: #333;
            font-family: 'Belleza', sans-serif;
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--gold);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
            font-family: 'Dancing Script', cursive;
        }

        /* Payment Method Styles */
        .payment-method {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-method.active {
            border-color: var(--gold);
            background-color: rgba(218, 165, 32, 0.05);
        }

        .payment-method-logo {
            height: 30px;
            margin-right: 10px;
        }

        .payment-details {
            display: none;
            padding: 1rem;
            background-color: var(--background);
            border-radius: var(--radius);
            margin-top: 1rem;
        }

        .payment-details.active {
            display: block;
        }

        .summary-card {
            background-color: var(--background);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Footer Styles */
        footer {
            background-color: #212529;
            color: goldenrod;
            font-family: 'Belleza', sans-serif;
            border-top: 2px solid var(--border);
            margin-top: 3rem;
        }

            footer h2 {
                font-weight: 700;
            }

            footer h5 {
                font-weight: 600;
                letter-spacing: 1px;
                border-bottom: 1px solid goldenrod;
                padding-bottom: 0.5rem;
                display: inline-block;
            }

            footer a {
                color: goldenrod;
                text-decoration: none;
                transition: all 0.3s ease;
            }

                footer a:hover {
                    opacity: 0.8;
                    padding-left: 3px;
                }

            footer .social-links a {
                font-size: 1.2rem;
                transition: transform 0.3s ease;
            }

                footer .social-links a:hover {
                    transform: translateY(-3px);
                }

        @media (max-width: 768px) {
            .nav-links ul {
                flex-direction: column;
                gap: 1rem;
            }

            .page-title {
                font-size: 1.8rem;
            }

            .page-subtitle {
                font-size: 1rem;
            }
        }

        #card-element {
            padding: 12px;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            background: white;
        }

        .StripeElement {
            width: 100%;
            padding: 10px 12px;
            border-radius: 4px;
            border: 1px solid transparent;
            box-shadow: 0 1px 3px 0 #e6ebf1;
            -webkit-transition: box-shadow 150ms ease;
            transition: box-shadow 150ms ease;
        }

        .StripeElement--focus {
            box-shadow: 0 1px 3px 0 #cfd7df;
        }

        .StripeElement--invalid {
            border-color: #fa755a;
        }

        .StripeElement--webkit-autofill {
            background-color: #fefde5 !important;
        }
    </style>
    <title>Payment | Decore&More</title>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="/css/darkMode.css">
    <script src="/js/darkMode.js"></script>
  </head>
  <body>
    <style>

    .dropdown {
        position: relative;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
        display: none;
        flex-direction: column;
        min-width: 150px;
    }

    .dropdown-menu a {
        display: block;
        padding: 10px;
        color: black;
        text-decoration: none;
    }

    .dropdown-menu a:hover {
        background: #f4f4f4;
    }


    .dropdown:hover .dropdown-menu {
        display: flex;
    }
    
      .logo-hero {
    background: linear-gradient(90deg, #d4af37 0%, #ffd700 50%, #bfa14a 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    color: transparent;
    font-weight: bold;
}

    </style>
    <!-- Navbar -->
    <div class="container" data-aos="zoom-in" data-aos-duration="1200">
      <div class="row">
        <div
          class="navv-bar py-4 d-flex justify-content-between align-items-center">
          <div class="logo-hero d-flex align-items-center" style="font-size: 35px;"
            data-aos="fade-down"
            data-aos-duration="1200">
            <button class="btn btn-outline-dark ms-auto "
              onclick="history.back()">
              <i class="fa-solid fa-arrow-left"></i> Back
            </button>

            Decore&More
          </div>
          <div class="menu-btn d-lg-none" data-aos="fade-up"
            data-aos-duration="1200">
            <i class="fa-solid fa-bars"></i>
          </div>
          <div class="nav-links" data-aos="fade-up" data-aos-duration="1200">
            <ul class="list-unstyled m-0">
              <li><a href="/" class="nav-link">Home</a></li>
              <li><a href="/#op" class="nav-link">About</a></li>
              <li class="dropdown">
                <a href="/#od" class="nav-link">Services</a>
                <div class="dropdown-menu">
                  <a href="/packages/by-occasion?occasion=Birthday"
                    class="nav-link">Birthday</a>
                  <a href="/packages/by-occasion?occasion=Wedding"
                    class="nav-link">Wedding</a>
                  <a href="/packages/by-occasion?occasion=Engagement"
                    class="nav-link">Engagement</a>
                  <a href="/packages/by-occasion?occasion=BabyShower"
                    class="nav-link">BabyShower</a>
                </div>
              </li>
              <li><a href="/designers" class="nav-link">Designers</a></li>
              <% if (!user || !user.name) { %>
              <li class="dropdown">
                <a href="#" class="nav-link">Register</a>
                <div class="dropdown-menu">
                  <a href="/registerCustomer">Customer</a>
                  <a href="/register">Engineer</a>
                </div>
              </li>
              <% } %>

              <% if (!user || !user.name) { %>
              <li class="dropdown">
                <a href="#" class="nav-link">Login</a>
                <div class="dropdown-menu">
                  <a href="/login">Customer</a>
                  <a href="/login">Engineer</a>
                </div>
              </li>
              <% } %>

              <li><a href="/contact" class="nav-link">Contact</a></li>

              <% if (user && user.name) { %>
              <li class="dropdown">
                <a href="#" class="nav-link d-flex align-items-center">
                  <i class="fa-solid fa-user"></i>
                  <span><%= user.name %></span>
                </a>
                <div class="dropdown-menu">
                  <a href="/userProfile/<%= user.id %>" class="nav-link">
                    <i class="fas fa-user me-2"></i>Profile
                  </a>
                  <a href="#" class="nav-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                  </a>
                </div>
              </li>
              <% }else{ %>

              <% } %>
              <button onclick="toggleDarkMode()" class="dark-mode"
                aria-label="Toggle dark mode">
                <i class="fa-solid fa-moon" aria-hidden="true"
                  title="Toggle to dark mode"></i>
              </button>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <script>
      function logout() {
      fetch("/logout", { method: "POST" }).then(() => {
        const userRole = '<%= user ? user.role : "" %>';
        if (userRole === 'Engineer') {
          window.location.href = "/login";
        } else {
          window.location.href = "/";
        }
      });
    }
</script>
    <!-- Payment Form -->
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <div class="card shadow-lg">
            <div class="card-body p-4 p-md-5">
              <h1 class="page-title section-gradient-title">Payment</h1>
              <p class="page-subtitle">Complete your booking with a secure
                payment</p>

              <!-- Order Summary -->
              <div class="summary-card mb-4 p-4 bg-light rounded shadow-sm">
                <h4 class="section-title mb-3 section-gradient-title">Order Summary</h4>
                <div class="row align-items-center">
                  <div class="col-md-6">
                    <p class="mb-2"><strong>Booking ID:</strong> <%= bookingId
                      %></p>
                    <p class="mb-2"><strong>Package:</strong> <%= packageName
                      %></p>
                    <p class="mb-2"><strong>Event Date:</strong> <%= eventDate ?
                      eventDate : '---' %></p>
                  </div>
                  <div class="col-md-6 text-md-end">
                    <div class="fs-5 fw-bold text-success mb-2">Partial Amount
                      Due: <span style="color:#1a7f37;"><%= deposit %>
                        EGP</span></div>
                    <div class="text-muted">The remaining <%= price - deposit %>
                      EGP will be paid in cash to the designer during their
                      visit.</div>
                  </div>
                </div>
              </div>

              <h4 class="section-title section-gradient-title">Payment Method</h4>
              <form id="payment-form">
                <!-- Hidden fields for payment data -->
                <input type="hidden" id="deposit-amount" value="<%= deposit %>">
                <input type="hidden" id="package-name"
                  value="<%= packageName %>">
                <input type="hidden" id="package-id" value="<%= packageId %>">
                <input type="hidden" id="event-date" value="<%= eventDate %>">
                <input type="hidden" id="user-id"
                  value="<%= user?.id || user?._id || '' %>">
                <input type="hidden" id="event-type" value="<%= eventType %>">

                <div class="mb-4">
                  <label for="card-element" class="form-label">Credit or debit
                    card</label>
                  <div id="card-element" class="form-control">
                    <!-- Stripe Card Element will be inserted here -->
                  </div>
                  <div id="card-errors" role="alert"
                    class="text-danger mt-2"></div>
                </div>

                <button type="submit" class="btn btn-gold w-100"
                  id="submit-button">
                  Pay <%= deposit %> EGP
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="bg-dark text-warning py-5">
      <div class="container">
        <div class="row g-4">
          <div class="col-12 text-center mb-4">
            <h2 class="display-4 fw-bold section-gradient-title">Decor&More</h2>
          </div>
          <div class="col-md-4">
            <h5 class="border-bottom border-warning pb-2">Contact Us</h5>
            <div class="mt-3">
              <p><i
                  class="bi bi-envelope-fill me-2"></i>info@decorandmore.com</p>
              <a href="https://web.whatsapp.com/send?phone=201556159175"
                target="_blank">
                <p><i class="bi bi-telephone-fill me-2"></i>+20 1556159175</p>
              </a>
              <p><i class="bi bi-geo-alt-fill me-2"></i>123 Decor Street, Design
                City</p>
            </div>
          </div>
          <div class="col-md-4">
            <h5 class="border-bottom border-warning pb-2">Quick Links</h5>
            <ul class="list-unstyled mt-3">
              <li class="mb-2"><a href="/"
                  class="text-warning text-decoration-none">Home</a></li>
              <li class="mb-2"><a href="/#op"
                  class="text-warning text-decoration-none">About</a></li>
              <% if (!user) { %>
              <li class="mb-2"><a href="/login"
                  class="text-warning text-decoration-none">login</a></li>
              <li class="mb-2"><a href="/register"
                  class="text-warning text-decoration-none">register</a></li>
              <% } %>
            </ul>
          </div>
          <div class="col-md-4">
            <h5 class="border-bottom border-warning pb-2">Follow Us</h5>
            <div class="mt-3 d-flex gap-3">
              <a href="#" class="text-warning fs-4" aria-label="Facebook"><i
                  class="bi bi-facebook"></i></a>
              <a href="#" class="text-warning fs-4" aria-label="Instagram"><i
                  class="bi bi-instagram"></i></a>
              <a href="#" class="text-warning fs-4" aria-label="Twitter"><i
                  class="bi bi-twitter-x"></i></a>
              <a href="#" class="text-warning fs-4" aria-label="LinkedIn"><i
                  class="bi bi-linkedin"></i></a>
            </div>
          </div>
          <div class="col-12">
            <hr class="border-warning">
            <p class="text-center mb-0">&copy; 2024 Decor&More. All rights
              reserved.</p>
          </div>
        </div>
      </div>
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
          const form = document.getElementById('payment-form');
          const submitButton = document.getElementById('submit-button');
          const depositAmount = document.getElementById('deposit-amount').value;
          const packageName = document.getElementById('package-name').value;
          const packageId = document.getElementById('package-id').value;
          const eventDate = document.getElementById('event-date').value;
          const userId = document.getElementById('user-id').value;
          const eventType = document.getElementById('event-type').value;


          const stripe = Stripe('<%= stripePublicKey %>');
          const elements = stripe.elements();
          const card = elements.create('card');
          card.mount('#card-element');

          form.addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log('Form submit triggered');

            if (!form.checkValidity()) {
              event.stopPropagation();
              form.classList.add('was-validated');
              return false;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

            try {
              const { paymentMethod, error } = await stripe.createPaymentMethod({
                type: 'card',
                card: card
              });

              if (error) throw error;

              const response = await fetch('/process-payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  payment_method_id: paymentMethod.id,
                  amount: Math.round(parseFloat(depositAmount) * 100),
                  package_name: packageName,
                  package_id: packageId,
                  event_date: eventDate,
                  user_id: userId,
                  event_type: eventType
                })
              });

              const result = await response.json();

              if (result.status === 'requires_action' && result.next_action?.redirect_to_url?.url) {
                window.location.href = result.next_action.redirect_to_url.url;
              } else if (result.status === 'succeeded') {
                window.location.href = '/payment-success';
              } else {
                throw new Error('Payment was not successful');
              }

            } catch (error) {
              submitButton.disabled = false;
              submitButton.innerHTML = `Pay ${depositAmount} EGP`;
              const errorElement = document.getElementById('card-errors');
              errorElement.textContent = error.message || 'An error occurred. Please try again.';
            }
          });

          card.addEventListener('change', function(event) {
            const displayError = document.getElementById('card-errors');
            displayError.textContent = event.error ? event.error.message : '';
          });
        });
      </script>

  </body>
</html>
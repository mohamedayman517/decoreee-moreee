# User Profile Routes Structure - Decor & More

تم إعادة هيكلة routes الملفات الشخصية للمستخدمين لتحسين التنظيم وسهولة الصيانة.

## البنية الجديدة:

```
routes/userProfile/
├── index.js          # الملف الرئيسي الذي يجمع كل userProfile routes
├── view.js           # عرض الملفات الشخصية
├── update.js         # تحديث الملفات الشخصية
├── password.js       # إدارة كلمات المرور
├── account.js        # إدارة الحسابات (حذف)
├── helpers.js        # الدوال المساعدة المشتركة
└── README.md         # هذا الملف
```

## الملفات:

### 1. `index.js`
- الملف الرئيسي الذي يستورد ويجمع كل userProfile routes
- يتم استيراده في `app.js`

### 2. `view.js`
- `GET /userProfile` - عرض الملف الشخصي للمستخدم الحالي
- `GET /userProfile/:id` - عرض ملف شخصي محدد
- تحميل بيانات الحجوزات والمهندسين المفضلين

### 3. `update.js`
- `POST /update` - تحديث الملف الشخصي
- رفع صور الملف الشخصي وتحويلها لـ base64
- تحديث بيانات المهندسين في الحجوزات والمفضلة

### 4. `password.js`
- `POST /change-password` - تغيير كلمة المرور
- التحقق من كلمة المرور الحالية
- تشفير كلمة المرور الجديدة

### 5. `account.js`
- `DELETE /delete-account` - حذف الحساب
- حذف البيانات المرتبطة (مشاريع، باقات، حجوزات)
- تنظيف الجلسة

### 6. `helpers.js`
- `upload` - إعدادات Multer لرفع الملفات
- `isAuthenticated` - middleware للتحقق من المصادقة

## المميزات:

### ✅ **تنظيم أفضل:**
- فصل عمليات العرض عن التحديث وإدارة كلمات المرور
- كل ملف متخصص في وظيفة محددة
- كود أنظف وأكثر تركيز

### ✅ **أمان محسن:**
- التحقق من المصادقة في كل route
- تشفير كلمات المرور
- تنظيف الملفات المؤقتة

### ✅ **إدارة شاملة:**
- عرض الملفات الشخصية مع البيانات المرتبطة
- تحديث شامل للبيانات في جميع المواضع
- حذف آمن للحسابات مع تنظيف البيانات

## API Endpoints:

### **عرض الملفات:**
- `GET /userProfile` - الملف الشخصي الحالي
- `GET /userProfile/:id` - ملف شخصي محدد

### **تحديث الملفات:**
- `POST /update` - تحديث الملف الشخصي

### **إدارة كلمات المرور:**
- `POST /change-password` - تغيير كلمة المرور

### **إدارة الحسابات:**
- `DELETE /delete-account` - حذف الحساب

## الوظائف الرئيسية:

### **عرض الملفات الشخصية:**
- عرض بيانات المستخدم الأساسية
- تحميل صور المهندسين في الحجوزات
- عرض المهندسين المفضلين مع صورهم

### **تحديث الملفات:**
- تحديث الاسم والسيرة الذاتية
- رفع صور جديدة وتحويلها لـ base64
- تحديث بيانات المهندس في جميع الحجوزات والمفضلة
- تحديث بيانات الجلسة

### **إدارة كلمات المرور:**
- التحقق من كلمة المرور الحالية
- تشفير كلمة المرور الجديدة
- حفظ كلمة المرور المشفرة

### **حذف الحسابات:**
- حذف المهندس مع مشاريعه وباقاته
- حذف العميل مع تنظيف حجوزاته من المهندسين
- تدمير الجلسة

## مثال للاستخدام:

### قبل (في ملف واحد):
```javascript
// userProfileRoutes.js (257 سطر)
router.get("/userProfile", async (req, res) => {
  // منطق عرض الملف الشخصي
});

router.post("/update", upload.single("profilePhoto"), async (req, res) => {
  // منطق تحديث الملف الشخصي
});

router.post("/change-password", async (req, res) => {
  // منطق تغيير كلمة المرور
});
```

### بعد (منظم في ملفات):
```javascript
// view.js
router.get("/userProfile", async (req, res) => {
  // منطق العرض فقط
});

// update.js
router.post("/update", upload.single("profilePhoto"), async (req, res) => {
  // منطق التحديث فقط
});

// password.js
router.post("/change-password", async (req, res) => {
  // منطق كلمات المرور فقط
});
```

## الأمان والتحقق:

### **التحقق من المصادقة:**
```javascript
const isAuthenticated = async (req, res, next) => {
  if (req.session && req.session.user) {
    // التحقق من وجود المستخدم في قاعدة البيانات
    const userId = req.session.user._id || req.session.user.id;
    let user = await User.findById(userId);
    if (!user) user = await Client.findById(userId);
    
    if (user) {
      return next();
    } else {
      // إذا تم حذف المستخدم، تدمير الجلسة
      req.session.destroy(() => {
        return res.redirect("/login?message=Your account has been deleted.");
      });
    }
  } else {
    res.status(401).json({ error: "Unauthorized: Please log in." });
  }
};
```

### **رفع الملفات:**
- حد أقصى 5MB للصور
- قبول JPEG, JPG, PNG فقط
- تحويل الصور لـ base64 للتخزين
- تنظيف الملفات المؤقتة

## الفوائد:

1. **كود أنظف** - كل ملف متخصص في وظيفة واحدة
2. **صيانة أسهل** - تعديل منطق العرض أو التحديث منفصل
3. **أمان أفضل** - التحقق من المصادقة والتشفير
4. **تطوير أسرع** - فرق متعددة تعمل على أجزاء مختلفة
5. **إدارة أفضل** - تحديث شامل للبيانات المرتبطة

## ملاحظات:

- ✅ تم الحفاظ على نفس الوظائف بالضبط
- ✅ نفس API endpoints والـ responses
- ✅ تحسين الأمان والتحقق
- ✅ تنظيف الملفات المؤقتة تلقائياً

## الخطوات التالية:

1. إضافة validation أفضل للبيانات المدخلة
2. تحسين error handling
3. إضافة audit logs للتغييرات
4. تحسين UI/UX للملفات الشخصية
